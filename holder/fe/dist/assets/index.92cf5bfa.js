import{a as w,g as E,b as M}from"./index.8bc7e9a0.js";import{E as g,a as z}from"./index.6a75cc6f.js";import{a as x,a3 as $,w as K,q as P,an as m,o as u,b as y,_ as s,U as d,Y as _,e as n,Z as b,F as V,ad as D,T as v,X as h}from"./vue.2af5998e.js";const W={class:"policy"},q={m:"4"},L={m:"t-0 b-2"},X={m:"t-0 b-2"},Y={m:"t-0 b-2"},Z={style:{"margin-top":"10px"}},G={class:"dialog-footer"},H={class:"dialog-contain"},Q={class:"dialog-footer"},ee=x({name:"policyIndex"}),te=x({...ee,setup(ae){const e=$({test:[],statusObj:{0:"审核中",1:"审核通过",2:"审核拒绝"},cerTemplateSubjectData:[],cerTemplateSelectData:[],credentialType:"",credentialFormData:{name:"",phone:""},showVcData:"",creDialogVisible:!1,verDialogVisible:!1,tableData:[],verBid:"",verResult:"",credentialAddress:"http://localhost:7001/createCredential",verifyAddress:"http://localhost:7001/verCredential",id:""}),C=l=>{e.verDialogVisible=!0,e.showVcData=JSON.stringify(l.certificate_vc),e.id=l.id},S=()=>{e.verDialogVisible=!1,e.verResult="",e.verBid=""},T=()=>{e.cerTemplateSubjectData=[],e.credentialType="",e.creDialogVisible=!1},N=async l=>{let a={message:e.showVcData};window.bifWallet.signMessage(a,async r=>{r.data.verid=e.id;let p=await w.post(e.verifyAddress,r.data);p.data.code===200?(g({message:"验证成功",type:"success"}),e.verResult=p.data.data.verified,e.verBid=p.data.data.verBid,S()):g({message:p.data.error.message,type:"error"})})},k=()=>{e.creDialogVisible=!0},B=async()=>{let l=JSON.parse(localStorage.getItem("userInfo")),a={credentialType:e.credentialType,cerTemplateSubjectData:e.cerTemplateSubjectData},i={bid:l.bid,credentialSubject:JSON.stringify(a),publicKey:l.publicKey},r={message:JSON.stringify(i)};window.bifWallet.signMessage(r,async c=>{console.log("res1",c);let{data:o}=await w.post(e.credentialAddress,c.data);console.log("res: ",o),o.code===200?(j(),g({message:"生成成功",type:"success"}),T()):g({message:o.data.error.message,type:"error"})})},j=async()=>{var i,r,p,c;let{data:l}=await w.post("http://localhost:7001/findAgentCredentialBybid",{}),a={0:"未核验",1:"核验成功"};if(l.code==200){for(const o of l.data)o.statu=e.statusObj[o.iss_status]||"审核中",o.ver_statu=a[o.ver_status]||"核验中",o.certificate_vc=JSON.parse(o.certificate_vc),o.credentialName=(i=o.certificate_vc.credentialSubject)==null?void 0:i.credentialType,o.issuanceDate=U(o.created_time),o.creBid=o.credential_bid,o.vc=(p=(r=o==null?void 0:o.certificate_vc)==null?void 0:r.proof)!=null&&p.jwt?A((c=o.certificate_vc.proof)==null?void 0:c.jwt):"";console.log("res.data",l.data),e.tableData=l.data}},O=async()=>{let l=await E({});console.log("res",l),l.code===200&&(e.cerTemplateSelectData=l.data)},U=l=>{const a=new Date(l),i={year:"numeric",month:"long",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return new Intl.DateTimeFormat("zh-CN",i).format(a)};function A(l){const a=l.split("."),i=M.Buffer.from(a[1],"base64").toString("utf-8");return JSON.parse(i)}return K(()=>{e.cerTemplateSelectData.forEach(l=>{console.log("item.templateSubject: ",l.templateSubject),l.templateName===e.credentialType&&(e.cerTemplateSubjectData=JSON.parse(l.templateSubject),console.log("state.cerTemplateSubjectData: ",e.cerTemplateSubjectData))})}),P(()=>{O(),j()}),(l,a)=>{const i=m("el-button"),r=m("el-table-column"),p=m("el-table"),c=m("el-input"),o=m("el-dialog"),I=m("el-option"),J=m("el-select"),F=m("el-form-item"),R=m("el-form");return u(),y("div",W,[s(i,{style:{"margin-left":"1300px"},type:"primary",onClick:k},{default:d(()=>[_(" 申请凭证 ")]),_:1}),s(p,{data:e.tableData,style:{width:"100%"}},{default:d(()=>[s(r,{type:"expand"},{default:d(t=>[n("div",q,[n("p",L," @context: "+b(t.row.vc.vc["@context"]),1),n("p",X,"type: "+b(t.row.vc.vc.type),1),n("p",Y," 申请凭证类型: "+b(t.row.vc.vc.credentialSubject.credentialType),1),(u(!0),y(V,null,D(t.row.vc.vc.credentialSubject.cerTemplateSubjectData,f=>(u(),y("p",{key:f.name,m:"t-0 b-2"},b(f.name)+":"+b(f.value),1))),128))])]),_:1}),s(r,{label:"id",prop:"id",width:"120"}),s(r,{label:"凭证类型",prop:"credentialName",width:"120"}),s(r,{label:"凭证申请日期",prop:"issuanceDate",width:"220"}),s(r,{label:"发证人",prop:"creBid",width:"220"}),s(r,{label:"凭证申请状态",prop:"statu",width:"220"}),s(r,{label:"凭证核验状态",prop:"ver_statu",width:"220"}),s(r,{label:"操作","min-width":"130"},{default:d(t=>[t.row.iss_status==1?(u(),v(i,{key:0,size:"large",onClick:f=>C(t.row)},{default:d(()=>[_(" 验证凭证 ")]),_:2},1032,["onClick"])):h("",!0)]),_:1})]),_:1},8,["data"]),s(o,{modelValue:e.verDialogVisible,"onUpdate:modelValue":a[3]||(a[3]=t=>e.verDialogVisible=t),"before-close":S,title:"Tips",width:"780"},{footer:d(()=>[n("div",G,[s(i,{type:"primary",onClick:a[2]||(a[2]=t=>N())},{default:d(()=>[_(" 验证 ")]),_:1})])]),default:d(()=>[n("div",null,[s(c,{modelValue:e.showVcData,"onUpdate:modelValue":a[0]||(a[0]=t=>e.showVcData=t),rows:16,placeholder:"Please input",style:{width:"720px"},type:"textarea"},null,8,["modelValue"])]),n("div",Z,[_(" 验证方地址: "),s(c,{modelValue:e.verifyAddress,"onUpdate:modelValue":a[1]||(a[1]=t=>e.verifyAddress=t),placeholder:"请输入验证方地址",style:{width:"240px"}},null,8,["modelValue"]),n("p",null,"验证方: "+b(e.verBid),1),n("p",null,"验证结果: "+b(e.verResult),1)])]),_:1},8,["modelValue"]),s(o,{modelValue:e.creDialogVisible,"onUpdate:modelValue":a[7]||(a[7]=t=>e.creDialogVisible=t),"before-close":T,title:"Tips",width:"780"},{footer:d(()=>[n("div",Q,[s(i,{type:"primary",onClick:a[6]||(a[6]=t=>B())},{default:d(()=>[_(" 申请凭证 ")]),_:1})])]),default:d(()=>[n("div",H,[n("div",null,[_(" 申请凭证类型： "),s(J,{modelValue:e.credentialType,"onUpdate:modelValue":a[4]||(a[4]=t=>e.credentialType=t),placeholder:"Select",size:"large",style:{width:"240px"}},{default:d(()=>[(u(!0),y(V,null,D(e.cerTemplateSelectData,t=>(u(),v(I,{key:t.id,label:t.templateName,value:t.templateName},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),s(R,{ref:"ruleFormRef",model:e.credentialFormData,class:"demo-ruleForm","label-width":"auto","status-icon":"",style:{"max-width":"600px","margin-top":"20px"}},{default:d(()=>[(u(!0),y(V,null,D(e.cerTemplateSubjectData,t=>(u(),v(F,{key:t.id,label:t.name,prop:"pass"},{default:d(()=>[t.type==="input"?(u(),v(c,{key:0,modelValue:t.value,"onUpdate:modelValue":f=>t.value=f,style:{width:"240px"}},null,8,["modelValue","onUpdate:modelValue"])):h("",!0),t.type==="select"?(u(),v(c,{key:1,modelValue:t.value,"onUpdate:modelValue":f=>t.value=f,style:{width:"240px"}},null,8,["modelValue","onUpdate:modelValue"])):h("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"]),n("div",null,[_(" 发证方地址: "),s(c,{modelValue:e.credentialAddress,"onUpdate:modelValue":a[5]||(a[5]=t=>e.credentialAddress=t),placeholder:"请输入发证方地址",style:{width:"240px"}},null,8,["modelValue"])])])]),_:1},8,["modelValue"])])}}});const re=z(te,[["__scopeId","data-v-949efc92"]]);export{re as default};
